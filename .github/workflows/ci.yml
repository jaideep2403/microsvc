name: Microservices CI/CD (AWS ECR - Single Repo)

on:
  pull_request:
    branches: [ main ]

  push:
    branches: [ main ]

  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 204645257245
  ECR_REPO: retail-msvc
  IMAGE_TAG: ${{ github.sha }}

concurrency:
  group: microsvc-${{ github.ref }}
  cancel-in-progress: true

jobs:
# --------------------------------------------------
# 1️⃣ Detect changed services
# --------------------------------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      ecommerce_ui: ${{ steps.changes.outputs.ecommerce-ui }}
      product_catalog: ${{ steps.changes.outputs.product-catalog }}
      product_inventory: ${{ steps.changes.outputs.product-inventory }}
      order_management: ${{ steps.changes.outputs.order-management }}
      shipping_and_handling: ${{ steps.changes.outputs.shipping-and-handling }}
      profile_management: ${{ steps.changes.outputs.profile-management }}
      contact_support_team: ${{ steps.changes.outputs.contact-support-team }}

    steps:
      - uses: actions/checkout@v4

      - id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ecommerce-ui: [ 'ecommerce-ui/**' ]
            product-catalog: [ 'product-catalog/**' ]
            product-inventory: [ 'product-inventory/**' ]
            order-management: [ 'order-management/**' ]
            shipping-and-handling: [ 'shipping-and-handling/**' ]
            profile-management: [ 'profile-management/**' ]
            contact-support-team: [ 'contact-support-team/**' ]

# --------------------------------------------------
# 2️⃣ PR → Build only (NO push)
# --------------------------------------------------
  build-pr:
    needs: detect-changes
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Export change flags
        run: |
          echo "ecommerce-ui=${{ needs.detect-changes.outputs.ecommerce_ui }}" >> $GITHUB_ENV
          echo "product-catalog=${{ needs.detect-changes.outputs.product_catalog }}" >> $GITHUB_ENV
          echo "product-inventory=${{ needs.detect-changes.outputs.product_inventory }}" >> $GITHUB_ENV
          echo "order-management=${{ needs.detect-changes.outputs.order_management }}" >> $GITHUB_ENV
          echo "shipping-and-handling=${{ needs.detect-changes.outputs.shipping_and_handling }}" >> $GITHUB_ENV
          echo "profile-management=${{ needs.detect-changes.outputs.profile_management }}" >> $GITHUB_ENV
          echo "contact-support-team=${{ needs.detect-changes.outputs.contact_support_team }}" >> $GITHUB_ENV

      - name: Build images (validation only)
        run: |
          services=("ecommerce-ui" "product-catalog" "product-inventory" "order-management" "shipping-and-handling" "profile-management" "contact-support-team")
          for service in "${services[@]}"; do
            if [ "${!service}" == "true" ]; then
              docker build -t test/$service:pr-${GITHUB_SHA::7} ./$service
            fi
          done

# --------------------------------------------------
# 3️⃣ main → Build & Push to AWS ECR
# --------------------------------------------------
  build-and-push:
    needs: detect-changes
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write   # REQUIRED for OIDC

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::204645257245:role/github-actions-oidc-role-ui3
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Export change flags
        run: |
          echo "ecommerce-ui=${{ needs.detect-changes.outputs.ecommerce_ui }}" >> $GITHUB_ENV
          echo "product-catalog=${{ needs.detect-changes.outputs.product_catalog }}" >> $GITHUB_ENV
          echo "product-inventory=${{ needs.detect-changes.outputs.product_inventory }}" >> $GITHUB_ENV
          echo "order-management=${{ needs.detect-changes.outputs.order_management }}" >> $GITHUB_ENV
          echo "shipping-and-handling=${{ needs.detect-changes.outputs.shipping_and_handling }}" >> $GITHUB_ENV
          echo "profile-management=${{ needs.detect-changes.outputs.profile_management }}" >> $GITHUB_ENV
          echo "contact-support-team=${{ needs.detect-changes.outputs.contact_support_team }}" >> $GITHUB_ENV

      - name: Build & Push images to ECR
        run: |
          services=("ecommerce-ui" "product-catalog" "product-inventory" "order-management" "shipping-and-handling" "profile-management" "contact-support-team")

          for service in "${services[@]}"; do
            if [ "${!service}" == "true" ]; then
              IMAGE="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${service}-${GITHUB_SHA::7}"

              docker buildx build \
                --push \
                --cache-from type=gha \
                --cache-to type=gha,mode=max \
                -t $IMAGE \
                ./$service
            fi
          done

# --------------------------------------------------
# 4️⃣ Update DEV manifests (GitOps)
# --------------------------------------------------
  update-dev-manifests:
    needs: build-and-push
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Export change flags
        run: |
          echo "ecommerce-ui=${{ needs.detect-changes.outputs.ecommerce_ui }}" >> $GITHUB_ENV
          echo "product-catalog=${{ needs.detect-changes.outputs.product_catalog }}" >> $GITHUB_ENV
          echo "product-inventory=${{ needs.detect-changes.outputs.product_inventory }}" >> $GITHUB_ENV
          echo "order-management=${{ needs.detect-changes.outputs.order_management }}" >> $GITHUB_ENV
          echo "shipping-and-handling=${{ needs.detect-changes.outputs.shipping_and_handling }}" >> $GITHUB_ENV
          echo "profile-management=${{ needs.detect-changes.outputs.profile_management }}" >> $GITHUB_ENV
          echo "contact-support-team=${{ needs.detect-changes.outputs.contact_support_team }}" >> $GITHUB_ENV

      - name: Update DEV manifests
        run: |
          services=("ecommerce-ui" "product-catalog" "product-inventory" "order-management" "shipping-and-handling" "profile-management" "contact-support-team")

          for service in "${services[@]}"; do
            if [ "${!service}" == "true" ]; then
              sed -i "s|image: .*|image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${service}-${GITHUB_SHA::7}|" \
                dev/manifest/$service.yaml
            fi
          done

      - name: Commit & push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit -am "Deploy to DEV - ${GITHUB_SHA::7}" || echo "No changes"
          git push
