name: Microservices CI/CD (Single Pipeline - AWS ECR)

on:
  pull_request:
    branches: [ main ]

  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "prod"
        type: choice
        options:
          - prod

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  IMAGE_TAG: ${{ github.sha }}

concurrency:
  group: microservices-${{ github.ref }}
  cancel-in-progress: true

jobs:
# --------------------------------------------------
# 1️⃣ Detect changed services
# --------------------------------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      ecommerce-ui: ${{ steps.changes.outputs.ecommerce-ui }}
      product-catalog: ${{ steps.changes.outputs.product-catalog }}
      product-inventory: ${{ steps.changes.outputs.product-inventory }}
      order-management: ${{ steps.changes.outputs.order-management }}
      shipping-and-handling: ${{ steps.changes.outputs.shipping-and-handling }}
      profile-management: ${{ steps.changes.outputs.profile-management }}
      contact-support-team: ${{ steps.changes.outputs.contact-support-team }}

    steps:
      - uses: actions/checkout@v4

      - id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ecommerce-ui: [ 'ecommerce-ui/**' ]
            product-catalog: [ 'product-catalog/**' ]
            product-inventory: [ 'product-inventory/**' ]
            order-management: [ 'order-management/**' ]
            shipping-and-handling: [ 'shipping-and-handling/**' ]
            profile-management: [ 'profile-management/**' ]
            contact-support-team: [ 'contact-support-team/**' ]

# --------------------------------------------------
# 2️⃣ PR → Build only (no push)
# --------------------------------------------------
  build:
    needs: detect-changes
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build images (validation only)
        run: |
          services=("ecommerce-ui" "product-catalog" "product-inventory" "order-management" "shipping-and-handling" "profile-management" "contact-support-team")
          for service in "${services[@]}"; do
            if [ "${{ needs.detect-changes.outputs[service] }}" == "true" ]; then
              docker build -t test/$service:pr-$GITHUB_SHA ./$service
            fi
          done

# --------------------------------------------------
# 3️⃣ main → Build & Push to AWS ECR
# --------------------------------------------------
  build-and-push:
    needs: detect-changes
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write   # OIDC

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push changed services to ECR
        run: |
          services=("ecommerce-ui" "product-catalog" "product-inventory" "order-management" "shipping-and-handling" "profile-management" "contact-support-team")
          for service in "${services[@]}"; do
            if [ "${{ needs.detect-changes.outputs[service] }}" == "true" ]; then
              ECR_IMAGE="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${service}:${GITHUB_SHA::7}"

              docker buildx build \
                --push \
                --cache-from type=gha \
                --cache-to type=gha,mode=max \
                -t $ECR_IMAGE \
                ./$service
            fi
          done

# --------------------------------------------------
# 4️⃣ Update DEV manifests (GitOps)
# --------------------------------------------------
  update-dev-manifests:
    needs: build-and-push
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Update DEV manifests
        run: |
          services=("ecommerce-ui" "product-catalog" "product-inventory" "order-management" "shipping-and-handling" "profile-management" "contact-support-team")
          for service in "${services[@]}"; do
            if [ "${{ needs.detect-changes.outputs[service] }}" == "true" ]; then
              sed -i "s|image: .*|image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/$service:${GITHUB_SHA::7}|" dev/manifest/$service.yaml
            fi
          done

      - name: Commit & push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit -am "Deploy to DEV - ${GITHUB_SHA::7}" || echo "No changes"
          git push

# --------------------------------------------------
# 5️⃣ Manual → Promote DEV → PROD
# --------------------------------------------------
  promote-prod:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - uses: actions/checkout@v4

      - name: Promote manifests
        run: |
          cp dev/manifest/* prod/manifest/
          git commit -am "Promote DEV to PROD"
          git push
